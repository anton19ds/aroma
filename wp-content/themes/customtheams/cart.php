<?php get_header(); ?>
<style>
	.breadcrum-banner .gurantee-section-bg {
		min-height: 350px;
	}

	.breadcrum-banner .gurantee-content {
		height: 350px !important;
		min-height: 350px !important;
	}

	.product-detail .img-remove-wrapper .prod-img-wrapper img {
		width: 100px;
		height: 100px;
		margin-bottom: 0px;
	}
	.product-detail .img-remove-wrapper .prod-img-wrapper {
		background: none;
	}
	.kg-span {
		font-weight: bold;
		font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
		font-family: 'Avenir Next LT Pro' !important;
		src: url(AvenirNextLTPro-HeavyCn.woff2) format('woff2'), url(AvenirNextLTPro-HeavyCn.woff) format('woff');
		font-weight: 600;
	}

	p.cart_empty_msg {
		font-size: 18px;
		color: #6c684a;
		text-align: center;
		font-weight: 600;
	}

	span.prod-offer-wrap b {
		font-family: 'Avenir Next LT Pro' !important;
	}

	span.prod-offer-wrap {
		font-family: 'Avenir Next LT Pro' !important;
		font-weight: 400 !important;
	}

	span.prod-incl {
		font-family: 'Avenir Next LT Pro' !important;
	}

	table tbody tr td:nth-of-type(2),
	table tbody tr td:nth-of-type(3) {
		font-family: 'Avenir Next LT Pro' !important;
		text-shadow: none !important;
		font-weight: 600 !important;
	}

	.new__buton__remove {
		color: #fff !important;
		background-color: #d9534f;
		border-color: #d9534f;
		padding: 2px 15px 3px 15px;
		border-radius: 2px;
		margin-top: 3px;
		display: block;
		width: fit-content;
		font-size: 15px;
	}

	.prod-title-sub-wgt-offer-wrapper {
		grid-row-gap: 0px;
	}

	.custom-shopcart-table .product-detail p {
		margin-bottom: 7px;
	}

	.img-remove-wrapper {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	}

	.total-wrapper {
		height: auto;
	}

	.subtol-wrap {
		font-family: 'Avenir Next LT Pro' !important;
		font-weight: 600;
	}

	.total-price {
		font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
		font-weight: 700 !important;
		font-family: 'Avenir Next LT Pro' !important;
		src: url(AvenirNextLTPro-BoldCn.woff2) format('woff2'), url(AvenirNextLTPro-BoldCn.woff) format('woff');
		font-weight: 600 !important;
	}

	p.free_ship_dis {
		font-size: 17px;
		line-height: 26px;
	}

	p.free_ship_dis {
		font-size: 17px;
		line-height: 26px;
	}

	.coupon-input-btn form {
		display: flex !important;
		justify-content: space-between;
		gap: 8px;
		margin-bottom: 20px;
	}

	.coupon-input-btn {
		justify-content: space-between;
		display: flex;
	}

	.coupon-input-btn {}

	.coupon-input-btn form button {
		width: 184px;
	}

	.subtol-wrap {
		font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
		font-weight: 700 !important;
	}

	span.prod-offer-wrap b {
		font-family: 'Avenir Next LT Pro' !important;
		src: url(AvenirNextLTPro-HeavyCn.woff2) format('woff2'), url(AvenirNextLTPro-HeavyCn.woff) format('woff');
		font-weight: 600;
	}

	.subtol-wrap {
		font-family: 'Avenir Next LT Pro' !important;
		src: url(AvenirNextLTPro-BoldCn.woff2) format('woff2'), url(AvenirNextLTPro-BoldCn.woff) format('woff');
		font-weight: 600 !important;
	}

	td.tot-val-mob-hide {
		color: #6c684a !important;
	}

	.prod-img-wrapper {
		margin-right: 0px;
	}

	.kg-span {
		font-weight: 600 !important;
		font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
	}

	span.prod-offer-wrap .kg-span {
		font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
	}

	span.prod-offer-wrap .kg-span {
		font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
		font-family: 'Avenir Next LT Pro' !important;
		src: url(AvenirNextLTPro-HeavyCn.woff2) format('woff2'), url(AvenirNextLTPro-HeavyCn.woff) format('woff');
		font-weight: 600;
	}

	@media only screen and (min-width: 300px) and (max-width: 991px) {
		.coupon-input-btn form {
			flex-direction: column;
			gap: 15px;
			margin-bottom: 15px;
		}

		.coupon-input-btn {
			display: block;
		}

		.coupon-input-btn form button {
			width: 100%;
		}

		.coupon-wrapper .coupon-input-btn {
			display: flex;
			flex-direction: column;
		}

		.coupon-wrapper .coupon-input-btn form {
			order: 1;
		}

		span.tot-val-desk-hide {
			text-shadow: none;
			font-family: 'Avenir Next LT Pro' !important;
			src: url(AvenirNextLTPro-HeavyCn.woff2) format('woff2'), url(AvenirNextLTPro-HeavyCn.woff) format('woff');
			font-weight: 600 !important;
			color: #6c684a;
			text-shadow: none !important;
		}

		.coupon-input-btn {
			grid-row-gap: 20px;
		}

		.table {
			margin-bottom: 5px;
		}

		.coupon-input-btn {
			margin-top: 15px;
		}

		.coupon-input-btn {
			grid-row-gap: 50px;
		}

		.kg-span {
			font-weight: 600 !important;
			font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
		}

		span.prod-offer-wrap .kg-span {
			font-family: 'Conv_Avenir Next LT Pro Condensed', Sans-Serif !important;
		}
	}
</style>
<?php
defined('ABSPATH') || exit;
do_action('woocommerce_before_cart'); ?>
<div class="gurantee-section breadcrum-banner shopping-section h-350">
	<div class="gurantee-section-bg"
		style="background-image: url('https://www.natureinbottle.com/images/order-banner.jpg');">
		<div class="gurantee-content">
			<h1>Shopping Cart</h1>
			<p>in Cart</p>
		</div>
	</div>
</div>
<div class="cart-wrapper">
	<div class="container" id="AppendCartSection">
		<div class="cart-start-btn-wrap">
			<a href="/">
				<i class="fa fa-arrow-left" aria-hidden="true"></i> Продолжить покупки</a>
			<a href="?clear-cart" class="button">
				<i class="fa fa-trash" aria-hidden="true"></i>
				<?php esc_html_e('Очистить корзину', 'woocommerce'); ?>
			</a>
		</div>
		<form class="woocommerce-cart-form" action="<?php echo esc_url(wc_get_cart_url()); ?>" method="post">
			<?php do_action('woocommerce_before_cart_table'); ?>
			<table class="table custom-shopcart-table">
				<thead>
					<tr>
						<th>Товары</th>
						<th>Цена</th>
						<th>Итого</th>
					</tr>
				</thead>
				<tbody>
					<?php do_action('woocommerce_before_cart_contents'); ?>
					<?php
					foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
						$_product = apply_filters('woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key);
						$product_id = apply_filters('woocommerce_cart_item_product_id', $cart_item['product_id'], $cart_item, $cart_item_key);
						$valueSize = get_field('size', $product_id);
						$product_name = apply_filters('woocommerce_cart_item_name', $_product->get_name(), $cart_item, $cart_item_key);
						if ($_product && $_product->exists() && $cart_item['quantity'] > 0 && apply_filters('woocommerce_cart_item_visible', true, $cart_item, $cart_item_key)) {
							$product = wc_get_product($_product->id);
							$name_parent = get_cross_sell_parents($_product->id);
							$product_link = get_permalink($name_parent->id);
							$product_permalink = apply_filters('woocommerce_cart_item_permalink', $_product->is_visible() ? $_product->get_permalink($cart_item) : '', $cart_item, $cart_item_key);
							?>
							<tr>
								<td>
									<div class="product-detail">
										<div class="img-remove-wrapper">
											<?php $image_url = wp_get_attachment_image_url(get_post_thumbnail_id($product_id), 'full'); ?>
											<a href="<?= esc_url($product_permalink) ?>" class="prod-img-wrapper"><img
													src="<?= $image_url ?>" alt=""></a>
										</div>
										<div class="prod-title-sub-wgt-offer-wrapper">
											<div class="prod-title-subtitle">
												<a href="<?= $product_link ?>">
													<?= $product_name ?>
												</a>
												<p class="product-heading"><?= $name_parent->name ?> (<?= $product->sku ?>)</p>
											</div>
											<div class="prod-wgt-offer-Wrap">

												<div>
													<?php if ($valueSize): ?>
														<span class="prod-size-wrap">Size:</span>
														<span class="prod-offer-wrap">
															<?= $valueSize ?>
														</span>
													<?php endif; ?>
												</div>
												<?php
												if ($_product->is_sold_individually()) {
													$min_quantity = 1;
													$max_quantity = 1;
												} else {
													$min_quantity = 0;
													$max_quantity = $_product->get_max_purchase_quantity();
												}

												$product_quantity = woocommerce_quantity_input(
													array(
														'input_name' => "cart[{$cart_item_key}][qty]",
														'input_value' => $cart_item['quantity'],
														'max_value' => $max_quantity,
														'min_value' => $min_quantity,
														'product_name' => $product_name,
													),
													$_product,
													false
												);
												?>
												<?php
												echo apply_filters( // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
													'woocommerce_cart_item_remove_link',
													sprintf(
														'<a href="%s" class="mob-hide new_buton_remove" aria-label="%s" data-product_id="%s" data-product_sku="%s">Удалить</a>',
														esc_url(wc_get_cart_remove_url($cart_item_key)),
														/* translators: %s is the product name */
														esc_attr(sprintf(__('Remove %s from cart', 'woocommerce'), wp_strip_all_tags($product_name))),
														esc_attr($product_id),
														esc_attr($_product->get_sku())
													),
													$cart_item_key
												);
												?>
												</a>
											</div>
										</div>
									</div>
								</td>
								<td>
									<div class="flex-height-fix">
										<div class="prod-price-wrapper">
											<span class="nos-span"> Nos. </span>
											<div class="table_col3">
												<div class="handle-counter" id="handleCounter<?= $product_id ?>">
													<button class="counter-minus left-counter-btn"
														onclick="javascript:setQty(<?= $product_id ?>,'remove',<?= $cart_item['quantity'] ?>,'small')">-</button>
													<input value="<?= $cart_item['quantity'] ?>" id="qty<?= $product_id ?>_qa"
														type="text" readonly="readonly" class="qty-value">
													<button class="counter-plus right-counter-btn"
														onclick="javascript:setQty(<?= $product_id ?>,'add',<?= $cart_item['quantity'] ?>,'small')">+</button>
												</div>
												<?php //print_r($cart_item) ?>
											</div>
											<span class="prod-incl">X <?php
											echo apply_filters('woocommerce_cart_item_price', WC()->cart->get_product_price($_product), $cart_item, $cart_item_key); // PHPCS: XSS ok.
											?></span>
											<span class="tot-val-desk-hide"><?= wc_price($cart_item['line_total']) ?></span>
										</div>
									</div>
								</td>
								<td class="tot-val-mob-hide" id="priseC<?= $product_id ?>">
									<?= wc_price($cart_item['line_total']) ?></td>
							</tr>
							<?php
						}
					}
					?>
				</tbody>
			</table>
			<?php do_action('woocommerce_after_cart_table'); ?>
		</form>
		<div class="total-wrapper">
			<div class="subtol-wrap">
				<span>Итого</span>
			</div>
			<div class="total-price">
				<span><?= WC()->cart->get_cart_total(); ?></span>
			</div>
		</div>
		<div class="coupon-wrapper">
			<div class="coupon-input-btn">
				<a href="/checkout/" class="checkout-btn">Оформить заказ</a>
			</div>
		</div>
		<div class="cart-start-btn-wrap">
			<a href="/">
				<i class="fa fa-arrow-left" aria-hidden="true"></i> Вернуться к покупкам
			</a>
		</div>
	</div>
</div>
<?php do_action('woocommerce_after_cart'); ?>
<?php get_footer(); ?>


<script>



	function setQty(pid, action, product_variant_id, ptype) {
		event.preventDefault();
		//alert("123");
		var ptype = ptype;
		if (ptype == '' || ptype == undefined) {
			ptype = 'small';
		}
		//var totalproduct = jQuery('#totalproduct').val();
		//totalproduct = parseInt(totalproduct);
		var inputBoxID = "qty" + pid + "_qa";
		var currQty = (document.getElementById(inputBoxID).value) * 1;
		// newQty = currQty;
		// if (action == 'add') {
		// 	var newQty = currQty + 1;
		// 	totalproduct = parseInt(totalproduct) + 1;
		// }
		// else if (action == 'remove') {
		// 	var newQty = currQty - 1;
		// 	totalproduct = parseInt(totalproduct) - 1;
		// }
		// var productID = pid;
		// var action = action;
		// var quantity = newQty;
		// if (quantity && quantity != '' && quantity != '0') {
		// 	quantity = parseInt(quantity);
		// }
		// if (productID == undefined) {
		// 	alert('something went wrong. Try again later.');
		// }
		// if (product_variant_id == undefined) {
		// 	alert('something went wrong. Try again later.');
		// }
		//var dataString = '&productID=' + productID + '&quantity=' + quantity + '&product_variant_id=' + product_variant_id + '&action=' + action + '&ptype=' + ptype;

		var bulk;
		var products = [];
		if (action == 'add') {
			bulk = 'woocommerce_bulk_add_to_cart';
			//var products = [];
			products.push({
				product_id: pid,
				quantity: 1
			});
		} else {
			bulk = 'remove_from_cart_by_product_id';
			var newQty = currQty - 1;
			products.push({
				product_id: pid,
				quantity: newQty
			});
		}
		jQuery.ajax({
			type: 'POST',
			url: wc_add_to_cart_params.ajax_url,
			data: {
				action: bulk,
				products: products
			},
			success: function (response) {
				jQuery.ajax({
					url: '/wp-json/wc/store/v1/cart',
					method: 'GET',
					success: function (cart) {
						jQuery('.total-price .woocommerce-Price-amount.amount').html((cart.totals.total_price / 100).toFixed(2).replace('.', ',') + cart.totals.currency_suffix);
						jQuery.each(cart.items, function (indexInArray, valueOfElement) {
							console.log(valueOfElement.id);
							jQuery('#qty' + valueOfElement.id + '_qa').val(valueOfElement.quantity);
							jQuery('#priseC' + valueOfElement.id).html((valueOfElement.totals.line_total / 100).toFixed(2).replace('.', ',') + valueOfElement.totals.currency_suffix);
						});
					}
				});
				if (response.error) {
					//jQuery(".notification-bar.sdiv").addClass('error').html(response.message).show();

				} else {
					//jQuery(".notification-bar.sdiv").addClass('success').show();
					// Обновляем счетчик корзины
					// if (response.fragments) {
					//     $.each(response.fragments, function(key, value) {
					//         $(key).replaceWith(value);
					//     });
					// }
				}

				// button.prop('disabled', false).text('Добавить выбранные товары');
				//setTimeout(function () { jQuery(".notification-bar.sdiv").fadeOut(); }, 3000);
			},
			error: function () {
				// message.addClass('error').html('Ошибка сервера').show();
				// button.prop('disabled', false).text('Добавить выбранные товары');
				// setTimeout(function() { message.fadeOut(); }, 3000);
			}
		});
		return false;
	}
</script>